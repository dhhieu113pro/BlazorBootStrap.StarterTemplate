@page "/"
@rendermode InteractiveWebAssembly
@using BlazorBootStrap.Client.Models
@using System.Xml.Serialization
@inject GoogleTrendClient googleTrendClient

<PageTitle>Google Trend now</PageTitle>

<h1>Google Trends Vietnam</h1>

<p>Real-time trending topics in Vietnam</p>

@if (isLoading)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (error != null)
{
    <div class="alert alert-danger" role="alert">
        <strong>Error:</strong> @error
    </div>
}
else if (trends?.Channel?.Items != null && trends.Channel.Items.Any())
{
    <div class="mb-4">
        <h5 class="text-muted">Total Trending Topics: @trends.Channel.Items.Count</h5>
        @if (!string.IsNullOrEmpty(trends.Channel.Title))
        {
            <p class="small"><strong>Channel:</strong> @trends.Channel.Title</p>
        }
    </div>

    <div class="row g-4">
        @foreach (var (trend, index) in trends.Channel.Items.Select((t, i) => (t, i)))
        {
            <div class="col-12 col-xl-6">
                <div class="card h-100 shadow-sm">
                    @if (!string.IsNullOrEmpty(trend.Picture))
                    {
                        <div class="position-relative">
                            <img src="@trend.Picture" class="card-img-top" alt="@trend.Title" style="max-height: 300px; object-fit: cover;" />
                            <span class="position-absolute top-0 start-0 badge bg-primary m-2">
                                #@(index + 1)
                            </span>
                        </div>
                    }
                    else
                    {
                        <div class="card-header bg-primary text-white">
                            <strong>#@(index + 1)</strong>
                        </div>
                    }

                    <div class="card-body">
                        <h4 class="card-title mb-3">@trend.Title</h4>

                        @if (!string.IsNullOrEmpty(trend.ApproxTraffic))
                        {
                            <div class="alert alert-info mb-3 py-2">
                                <i class="bi bi-graph-up-arrow"></i>
                                <strong>Approximate Traffic:</strong> @trend.ApproxTraffic searches
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(trend.PubDate))
                        {
                            <p class="text-muted small mb-2">
                                <i class="bi bi-clock"></i> Published: @trend.PubDate
                            </p>
                        }

                        @if (!string.IsNullOrEmpty(trend.Description))
                        {
                            <div class="card-text mb-3">
                                <h6 class="text-muted">Description:</h6>
                                <div class="border-start border-3 border-primary ps-3">
                                    @((MarkupString)trend.Description)
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(trend.PictureSource))
                        {
                            <p class="small text-muted mb-2">
                                <i class="bi bi-image"></i> Image Source: @trend.PictureSource
                            </p>
                        }

                        @if (trend.NewsItems != null && trend.NewsItems.Any())
                        {
                            <div class="mt-3">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-newspaper"></i> Related News (@trend.NewsItems.Count)
                                </h6>
                                <div class="list-group list-group-flush">
                                    @foreach (var (news, newsIndex) in trend.NewsItems.Select((n, i) => (n, i)))
                                    {
                                        <div class="list-group-item px-0">
                                            <div class="d-flex w-100 justify-content-between align-items-start mb-1">
                                                <h6 class="mb-1">
                                                    @if (!string.IsNullOrEmpty(news.Url))
                                                    {
                                                        <a href="@news.Url" target="_blank" class="text-decoration-none">
                                                            <i class="bi bi-link-45deg"></i> @news.Title
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <span>@news.Title</span>
                                                    }
                                                </h6>
                                                @if (!string.IsNullOrEmpty(news.Source))
                                                {
                                                    <span class="badge bg-secondary">@news.Source</span>
                                                }
                                            </div>
                                            @if (!string.IsNullOrEmpty(news.Snippet))
                                            {
                                                <p class="mb-1 small text-muted">@news.Snippet</p>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(trend.Link))
                    {
                        <div class="card-footer bg-transparent border-top">
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="@trend.Link" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="bi bi-box-arrow-up-right"></i> View on Google Trends
                                </a>
                                <small class="text-muted">Click to explore more</small>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i> No trends available at the moment.
    </div>
}

@code {
    private GoogleTrendsRss? trends;
    private bool isLoading = true;
    private string? error;
    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            error = null;

            // Fetch Google Trends RSS feed via backend proxy to avoid CORS
            var response = await googleTrendClient.GetTrendsAsync("VN");

            // Parse XML
            var serializer = new XmlSerializer(typeof(GoogleTrendsRss));
            using var reader = new StringReader(response);
            trends = (GoogleTrendsRss?)serializer.Deserialize(reader);
        }
        catch (Exception ex)
        {
            error = $"Failed to load Google Trends: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}

